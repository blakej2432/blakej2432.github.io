---
layout: post
title: TUYA 라이브러리 활용 데이터 수집
date: 2024-08-06 22:41 +0900
categories:
  - IoT/Vision
  - IoT
tags: 
math: true
---
## TUYA 라이브러리란?

- 스마트 홈 장치 및 IoT(사물 인터넷) 기기를 관리하기 위한 라이브러리
- TUYA 플랫폼을 통해 장치들을 제어하고 모니터링 가능
- 스마트폰 앱으로 리모컨 기능, 센싱 정보 등 확인
- 데이터 실시간 수집 -> 대시보드 제작 혹은 머신러닝 학습/추론 가능


------

## 설치

```python
pip3 install tuya-iot-py-sdk
```

[GitHub - tuya/tuya-iot-python-sdk: Tuya IoT Python SDK for Tuya Open API.](<https://github.com/tuya/tuya-iot-python-sdk>)

----

## 기기 제어하기

- 사용자 정보, 메소드 import

```python
import logging
from env import API_ENDPOINT, ACCESS_ID, ACCESS_KEY, USERNAME, PASSWORD
from tuya_iot import (
    TuyaOpenAPI,
    AuthType,
    TuyaOpenMQ,
    TuyaDeviceManager,
    TuyaHomeManager,
    TuyaDeviceListener,
    TuyaDevice,
    TuyaTokenInfo,
    TUYA_LOGGER
)
```

- API 연결

```python
openapi = TuyaOpenAPI(API_ENDPOINT, ACCESS_ID, ACCESS_KEY, AuthType.CUSTOM)
openapi.connect(USERNAME, PASSWORD)
openmq = TuyaOpenMQ(openapi)

deviceManager = TuyaDeviceManager(openapi, openmq)
```

- 내 device 확인하기

```python
homeManager = TuyaHomeManager(openapi, openmq, deviceManager)
homeManager.update_device_cache()

print(deviceManager.device_map.keys())

# dict_keys(['eb70e8eb15d5b251b2tgoz', 'eb8078b8b5cd24251c1pi4', 'ebb5ad34108b9222e7isch', 'ebc48e6edf02f0cea9dvgr', 'eb9feed874d7639256dque', 'eba23a4cfd34495875aylb'])
```




- 각 device 현 상태 확인, 실행할 수 있는 기능 확인
    - T&H 센서 - 온도(Temperature), 습도(Humidity) 를 측정하는 기기

        ```python
        # Device 상태확인
        deviceManager.get_device_status('eb70e8eb15d5b251b2tgoz') 
        ```
        
        - 온도, 습도, 배터리 상태, 섭씨화씨 모드
        ```python
        {
           "result":[
              {
                 "code":"va_temperature",
                 "value":320
              },
              {
                 "code":"va_humidity",
                 "value":37
              },
              {
                 "code":"battery_state",
                 "value":"high"
              },
              {
                 "code":"temp_unit_convert",
                 "value":"c"
              }
           ],
           "success":true,
           "t":1722928609110,
           "tid":"d8a8bc5453c311efac99a29de015e7c1"
        }
        ```
        
        ```python
        # Device 에 호출할 수 있는 기능 확인
        deviceManager.get_device_functions('eb70e8eb15d5b251b2tgoz')
        ```
        
        ```python
        {
           "result":{
              "category":"wsdcg",
              "functions":[
                 {
                    "code":"temp_unit_convert",
                    "desc":"temp unit convert",
                    "name":"temp unit convert",
                    "type":"Enum",
                    "values":"{\\"range\\":[\\"c\\",\\"f\\"]}"
                 }
              ]
           },
           "success":true,
           "t":1722928754648,
           "tid":"2f657e3653c411efac36c26b8e9c6cbb"
        }
        ```
        
    - Aubess Smart Socket EM - 스마트 플러그로, 콘센트에 꼽아 다른 기기의 전원을 차단/허용하거나 전력량 등을 측정할 수 있는 장치
        
        ```python
        deviceManager.get_device_status('eb8078b8b5cd24251c1pi4')
        ```
         
        - 전원 on/off 상태, 전압, 전류, 전력량 등 정보 확인
        ```python
        {
           "result":[
              {
                 "code":"switch_1",
                 "value":true
              },
              {
                 "code":"countdown_1",
                 "value":0
              },
              {
                 "code":"add_ele",
                 "value":1
              },
              {
                 "code":"cur_current",
                 "value":0
              },
              {
                 "code":"cur_power",
                 "value":0
              },
              {
                 "code":"cur_voltage",
                 "value":2139
              },
              {
                 "code":"relay_status",
                 "value":"power_on"
              },
              {
                 "code":"overcharge_switch",
                 "value":false
              },
              {
                 "code":"light_mode",
                 "value":"relay"
              },
              {
                 "code":"child_lock",
                 "value":false
              },
              {
                 "code":"cycle_time",
                 "value":""
              },
              {
                 "code":"random_time",
                 "value":""
              },
              {
                 "code":"switch_inching",
                 "value":""
              }
           ],
           "success":true,
           "t":1722928824341,
           "tid":"58f159fb53c411efac99a29de015e7c1"
        }
        ```
        
        ```python
        deviceManager.get_device_functions('eb8078b8b5cd24251c1pi4')
        ```
        
        ```json
        {
           "result":{
              "category":"cz",
              "functions":[
                 {
                    "code":"switch_1",
                    "desc":"switch 1",
                    "name":"switch 1",
                    "type":"Boolean",
                    "values":"{}"
                 },
                 {
                    "code":"countdown_1",
                    "desc":"countdown 1",
                    "name":"countdown 1",
                    "type":"Integer",
                    "values":"{\\"unit\\":\\"s\\",\\"min\\":0,\\"max\\":86400,\\"scale\\":0,\\"step\\":1}"
                 },
                 {
                    "code":"relay_status",
                    "desc":"relay status",
                    "name":"relay status",
                    "type":"Enum",
                    "values":"{\\"range\\":[\\"power_off\\",\\"power_on\\",\\"last\\"]}"
                 },
                 {
                    "code":"overcharge_switch",
                    "desc":"overcharge switch",
                    "name":"overcharge switch",
                    "type":"Boolean",
                    "values":"{}"
                 },
                 {
                    "code":"light_mode",
                    "desc":"light mode",
                    "name":"light mode",
                    "type":"Enum",
                    "values":"{\\"range\\":[\\"relay\\",\\"pos\\",\\"none\\"]}"
                 },
                 {
                    "code":"child_lock",
                    "desc":"child lock",
                    "name":"child lock",
                    "type":"Boolean",
                    "values":"{}"
                 },
                 {
                    "code":"cycle_time",
                    "desc":"cycle time",
                    "name":"cycle time",
                    "type":"String",
                    "values":"{}"
                 },
                 {
                    "code":"random_time",
                    "desc":"random time",
                    "name":"random time",
                    "type":"String",
                    "values":"{}"
                 },
                 {
                    "code":"switch_inching",
                    "desc":"switch inching",
                    "name":"switch inching",
                    "type":"String",
                    "values":"{}"
                 }
              ]
           },
           "success":true,
           "t":1722928838530,
           "tid":"6169a68b53c411efac99a29de015e7c1"
        }
        ```


이와 같이, Tuya를 통해 설치한 기기를 서버에서 제어하고, API를 호출하여 데이터를 실시간 수집할 수 있다.